<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulator „scan” robot</title>
  <style>
    :root { color-scheme: dark; }
    body{ background:#0b1220; color:#e8eefc; margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; }
    .wrap{ max-width:860px; margin:28px auto; padding:16px; }
    .card{ background:#121a2b; border:1px solid #2a3348; border-radius:12px; padding:18px;
           box-shadow:0 8px 24px rgba(0,0,0,.35) }
    h2{ margin:0 0 10px }
    .grid{ display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
    textarea,input{ width:100%; background:#0e1527; color:#e8eefc; border:1px solid #24304a; border-radius:8px; padding:10px }
    label{ font-size:12px; color:#9fb2d0 }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
    .btn{ background:#1d2a44; border:1px solid #2a3a60; border-radius:8px; padding:10px 12px; cursor:pointer; color:#e8eefc }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }
    pre{ background:#0e1527; border:1px solid #24304a; border-radius:10px; padding:12px; white-space:pre-wrap; overflow:auto; }
    .muted{ color:#94a3b8; }
    .ok{ color:#86efac }
    .bad{ color:#fca5a5 }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Simulator „scanare” robot</h2>
      <p class="muted">1) Deschide un <b>QR</b> de la un checkpoint și apasă <b>Copy JSON</b> • 2) Lipește mai jos • 3) Completează datele • 4) Trimite</p>

      <label for="payload">Payload din QR (JSON)</label>
      <textarea id="payload" rows="8" placeholder='{"v":1,"projectId":"...","apiKey":"...","slot":"...","roundId":"...","cpId":"...","m":1234567}'></textarea>

      <div class="grid" style="margin-top:10px">
        <div>
          <label for="teamId">teamId</label>
          <input id="teamId" placeholder="ex: team-1" />
        </div>
        <div>
          <label for="robotId">robotId</label>
          <input id="robotId" placeholder="ex: rpi-01" />
        </div>
        <div>
          <label for="temp">Temperatură (°C)</label>
          <input id="temp" placeholder="ex: 23.4" />
        </div>
        <div>
          <label for="hum">Umiditate (%)</label>
          <input id="hum" placeholder="ex: 52" />
        </div>
      </div>

      <div class="row">
        <button id="sendBtn" class="btn">Trimite către Firestore</button>
        <button id="fillDemo" class="btn">Umple demo</button>
      </div>

      <pre id="out" style="margin-top:12px"></pre>
    </div>
  </div>

  <script>
    const out = document.getElementById('out');
    const sendBtn = document.getElementById('sendBtn');
    const fillDemo = document.getElementById('fillDemo');

    function log(txt, cls){ out.className = cls || ''; out.textContent = txt; }
    const fv = {
      string: (s) => ({ stringValue: String(s) }),
      double: (n) => ({ doubleValue: Number(n) }),
      int:    (n) => ({ integerValue: String(Math.trunc(Number(n))) }),
      bool:   (b) => ({ booleanValue: !!b })
    };
    function sanitizeId(s){ return String(s||'').trim().replace(/[^\w\-]+/g,'_'); }

    async function getAnonIdToken(apiKey){
      const r = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${encodeURIComponent(apiKey)}`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ returnSecureToken:true })
      });
      if (!r.ok) throw new Error(`signUp failed: ${r.status} ${await r.text()}`);
      const j = await r.json();
      if (!j.idToken) throw new Error('no idToken in signUp response');
      return j.idToken;
    }

    async function commitScan({ projectId, idToken, docId, fields }){
      const url = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents:commit`;
      const body = {
        writes: [{
          update: {
            name: `projects/${projectId}/databases/(default)/documents/scans/${docId}`,
            fields
          }
        }]
      };
      const r = await fetch(url, {
        method:'POST',
        headers:{
          'Authorization': `Bearer ${idToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
      const txt = await r.text();
      if (!r.ok) throw new Error(`commit failed: ${r.status} ${txt}`);
      return txt;
    }

    fillDemo.onclick = () => {
      document.getElementById('teamId').value = 'team-1';
      document.getElementById('robotId').value = 'rpi-01';
      document.getElementById('temp').value = '23.40';
      document.getElementById('hum').value  = '52';
    };

    sendBtn.onclick = async () => {
      try{
        log('Trimit…', 'muted');
        const payloadRaw = document.getElementById('payload').value.trim();
        if (!payloadRaw) throw new Error('Lipește „Payload din QR”');

        const p = JSON.parse(payloadRaw);
        const teamId  = document.getElementById('teamId').value.trim();
        const robotId = document.getElementById('robotId').value.trim();
        const temp    = Number(document.getElementById('temp').value);
        const hum     = Number(document.getElementById('hum').value);

        if (!teamId || !robotId) throw new Error('Completează teamId și robotId');
        if (!Number.isFinite(temp) || !Number.isFinite(hum)) throw new Error('Temperatura/Umiditatea trebuie să fie numere');

        // 1) idToken anonim
        const idToken = await getAnonIdToken(p.apiKey);

        // 2) construim docId stabil (evităm spațiile)
        const docId = `${sanitizeId(teamId)}__${sanitizeId(p.roundId)}__${sanitizeId(p.cpId)}`;

        // 3) scriem în scans/*
        const fields = {
          teamId:   fv.string(teamId),
          robotId:  fv.string(robotId),
          roundId:  fv.string(p.roundId),
          cpId:     fv.string(p.cpId),
          qrMinute: fv.int(p.m),
          slot:     fv.string(p.slot),
          temp:     fv.double(temp),
          humidity: fv.double(hum),
          createdAtMs: fv.int(Date.now()),
        };
        const resp = await commitScan({ projectId:p.projectId, idToken, docId, fields });

        log('✓ Scan salvată! Răspuns Firestore:\n' + resp, 'ok');
      } catch(e){
        log('Eroare: ' + (e && e.message ? e.message : String(e)), 'bad');
      }
    };
  </script>
</body>
</html>
